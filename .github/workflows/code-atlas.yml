name: Code Atlas - Main Branch Analysis

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git metadata
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Link local version
        run: npm link
      
      - name: Scan codebase
        run: code-atlas scan --include-git
      
      - name: Check complexity threshold
        run: |
          MAX_COMPLEXITY=10
          ACTUAL=$(code-atlas stats --format json | jq -r '.averageComplexity // 0')
          echo "Average complexity: $ACTUAL (threshold: $MAX_COMPLEXITY)"
          if (( $(echo "$ACTUAL > $MAX_COMPLEXITY" | bc -l) )); then
            echo "âŒ Code complexity exceeds threshold!"
            exit 1
          fi
      
      - name: Generate dependency graphs
        run: |
          code-atlas graph --format mermaid --output dependency-graph.md
      
      - name: Generate HTML report
        run: code-atlas report --output code-atlas-report.html
      
      - name: Collect statistics
        id: stats
        run: |
          code-atlas stats > stats.txt
          code-atlas stats --format json > stats.json
          cat stats.txt
          
          # Extract key metrics
          TOTAL_FUNCTIONS=$(jq -r '.totalFunctions // 0' stats.json)
          AVG_COMPLEXITY=$(jq -r '.averageComplexity // 0' stats.json)
          echo "total_functions=$TOTAL_FUNCTIONS" >> $GITHUB_OUTPUT
          echo "avg_complexity=$AVG_COMPLEXITY" >> $GITHUB_OUTPUT
      
      - name: Add reports to summary
        if: always()
        run: |
          echo "## ðŸ“Š Code Atlas Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat stats.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f dependency-graph.md ]; then
            echo "### Dependency Graph" >> $GITHUB_STEP_SUMMARY
            cat dependency-graph.md >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-atlas-reports
          path: |
            code-atlas-report.html
            dependency-graph.md
            registry.json
            stats.txt
            stats.json
